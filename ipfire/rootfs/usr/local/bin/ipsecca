#!/bin/bash -x

if [ -f /etc/default/ssl ];
then
        . /etc/default/ssl
else
        echo "File $FILE does not exist."
        echo "error exit 1"
		return 1
fi



echo "Génération de la clé privé crypté avec un mot de passe."
echo
echo "Common Name : 'Intermediate Certification Authority for IPSec Service'"
echo "Oranization Unit :'Secure Digital Certificate Signing'"

openssl req -newkey rsa:8192 -sha256 -keyout ${PATH_SSL}/ipsec/private/ca.key -out ${PATH_SSL}/ipsec/ca.req  -config ${PATH_SSL}/${CONFIG}


echo "Signature du certificat d'autorité [IPSEC] par [ROOT]."
echo "Notre autorité de certification intermédiaire aura les extentions signalé dans la section IPSEC_CA."
openssl ca -extensions IPSEC_CA -in ${PATH_SSL}/ipsec/ca.req -out ${PATH_SSL}/ipsec/ca.pem -config ${PATH_SSL}/${CONFIG}

echo "Génèration du serial de ipsec_ca"
openssl x509 -serial -noout -in ${PATH_SSL}/ipsec/ca.pem | cut -d= -f2 > ${PATH_SSL}/ipsec/serial

echo
echo "On peut maintenant créer des certificats client/serveur et les signer avec notre autorité intermédiaire."
echo
# FIN IPSEC_CA

