#!/bin/bash

if [ -f /etc/default/ipsec ];
then
        . /etc/default/ipsec
else
        echo "File $FILE does not exist."
        echp "exit"
fi
SSL_PATH=/etc/ssl

cd ${SSL_PATH}/ipsec_ca
echo "Nom du client:"
read CLIENT
echo 
echo "Généreration de la clé privé."
echo 
echo "Common Name = ${CLIENT}.${CN}
echo "Org. Unit = Certificat Client IPSec"
echo "Org. Name = ${ORGANISATION}
openssl genrsa  -out private/${CLIENT}_ipsec.key 4096
echo
echo "Génération de la demande de certificat."
echo
openssl req -key private/${CLIENT}_ipsec.key -sha256 -out ${CLIENT}_ipsec.req -new -nodes -config /etc/ssl/ipsec.cnf
echo "Signature du certificat client avec l'autorité de certification ipsec intermédiaire."
echo
openssl ca -name ipsec_ca -extensions CLIENT_IPSEC -in ${CLIENT}_ipsec.req -out ${CLIENT}_ipsec.pem -config /etc/ssl/ipsec.cnf 
echo
echo "Portage des fichiers vers un format p12."
echo
openssl pkcs12 -export -inkey private/${CLIENT}_ipsec.key -in ${CLIENT}_ipsec.pem -name "${CLIENT}.${IPSEC_CN}" -certfile ipsec_ca.pem -caname "${IPSEC_CN}" -out ${CLIENT}.p12 

ln -s /etc/ssl/ipsec_ca/private/${CLIENT}_ipsec.key /var/ipfire/private/${CLIENT}key.pem
ln -s /etc/ssl/ipsec_ca/${CLIENT}_ipsec.pem /var/ipfire/certs/${CLIENT}cert.pem
ln -s /etc/ssl/ipsec_ca/${CLIENT}.p12 /var/ipfire/certs/${CLIENT}.p12

# FIN IPSEC_CA
# echo $((`wc -l /var/ipfire/vpn/config | awk '{ print $1}'`+1)),off,windows,CN=windows.10.10.100.8 OU=Certificat Client IPSec,host,cert,,,,0.0.0.0/0,,,172.16.0.0/24,,,,,,,,,,,,,,,,,,,,>>/var/ipfire/vpn/config
# ln -s /etc/ssl/ipsec_ca/private/windows_ipsec.key /var/ipfire/private/windowskey.pem
# ln -s /etc/ssl/ipsec_ca/windows_ipsec.pem /var/ipfire/certs/windowscert.pem
# ln -s /etc/ssl/ipsec_ca/windows.p12 /var/ipfire/certs/windows.p12

echo $((`wc -l /var/ipfire/vpn/config | awk '{ print $1}'`+1)),off,${CLIENT},CN=${CLIENT}.${CN} OU=Certificat Client IPSec,host,cert,,,,0.0.0.0/0,,,172.16.0.0/24,,,,,,,,,,,,,,,,,,,,>>/var/ipfire/vpn/config
